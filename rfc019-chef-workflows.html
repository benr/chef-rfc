<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable = no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation-essential/6.2.2/css/foundation.min.css">
    <style>
      a { color: #f18b21; }
      a:hover, a:focus { color: #3f5364; }
    </style>
    <title>Chef RFCs</title>
  </head>
  <body>
    <div class="row medium-12 columns">
      <header class="clearfix">
        <div class="left">
          <a href="/chef-rfc"><h1>Chef RFCs</h1></a>
        </div>
      </header>
<h1>The Great Workflow RFC</h1>

<p>This RFC is about Chef Workflow - which ones exist in the wild, which ones are supported, and how we as a community go about teaching folks:</p>

<ol>
<li>How to get started with Chef</li>
<li>How to create your Chef cookbooks</li>
<li>How to create your Chef policy (everything that isn&#39;t a cookbook)</li>
<li>How to manage external dependencies (on cookbooks, libraries, etc.)</li>
<li>How to test your cookbooks and policy</li>
<li>How to publish your cookbooks and policy</li>
</ol>

<p>This document covers each of these topics, and proposes two supported workflows for Chef: the monolithic repository workflow, and the independent software projects workflow.</p>

<p><em>Note: This RFC is written in active voice, but much of what it documents is not yet ready to be released on the world, in particular the unification of interfaces between multiple workflows. Hold tight, my friends. In particular, for the sake of sanity, assume the monolithic repository workflow works the same as the &#39;classic&#39; chef workflow. We&#39;ll unify the interface between the workflows, and push some smarts into that layer.</em></p>

<h2>What is a supported workflow?</h2>

<p>Chef has lots of moving parts, and as a tool, it is broadly un-opinionated about how you use them. That has real benefits when it comes to solving your day-to-day problems (for example, there is nothing about Chef you can&#39;t customize from a cookbook, which is awesome) - but it makes life difficult when you try and bring on new folks, or decide for yourself how to approach a problem.</p>

<p>The workflows in this document are &quot;supported&quot; for three reasons:</p>

<ol>
<li><em>They are battle hardened</em>: the entire community agrees that they are useful and broadly applicable in many real-world scenarios.</li>
<li><em>Tooling support</em>: the built-in tooling for Chef supports these workflows as first-class citizens - generators, test harnesses, etc will all work &quot;out-of-the-box&quot; with these workflows.</li>
<li><em>The Chef Development Kit</em>: In particular, the Chef Development Kit will support the supported workflows out-of-the-box.</li>
</ol>

<p>If you think you have another workflow, that&#39;s amazing! The currently supported workflows came about from experimentation just like yours. If it becomes mature enough to have broad ecosystem support, propose a change to this RFC.</p>

<p>All workflows and commands documented in this RFC assume you are using the <a href="http://downloads.getchef.com/chef-dk/">Chef Development Kit</a>.</p>

<h2>Chef DK &amp; Knife</h2>

<p><em>Note: This section can be removed once we are over it</em></p>

<p>We have long supported <code>knife</code> as a catch-all for workflow with Chef. Knife began life as the command line interface to the Chef Server API - and has grown literal wings. As we consolidate the various supported workflows, we&#39;re going to be moving the commands used in them to the <code>chef</code> command, for two reasons:</p>

<ol>
<li>It provides us a blank slate for implementation of new workflow super-powers</li>
<li>It ensures we won&#39;t break existing knife based workflows while we consolidate</li>
<li>It makes more sense from a &#39;come in alone&#39; perspective - the tool you use to do &#39;chef&#39; stuff as a developer is, unsurprisingly.. called &#39;chef&#39;.</li>
</ol>

<p>So this document talks primarily about the <code>chef</code> command, and not <code>knife</code>.</p>

<h1>How to get started with Chef</h1>

<p>This is the one step that should not differ between supported workflows.</p>

<p>Rather than detail every step here, lets call out a couple of important principles when you teach anyone how to use Chef.</p>

<ol>
<li>There are no shortcuts to building complex infrastructure - by extension, there are no shortcuts to building complex infrastructure with Chef. You have to learn things, piece by piece. Zooming someone to the end doesn&#39;t help - it actually hurts.</li>
<li>The concept of <a href="http://en.wikipedia.org/wiki/Progressive_disclosure">Progressive Disclosure</a> should always be kept in mind. Make more information available easily, but don&#39;t overwhelm users with every feature and possibility.</li>
<li>The <a href="http://learn.getchef.com">Learn Chef</a> site is the place for collaborating on early
stage tutorial content. If a user needs to learn the basics, send them here.</li>
<li>The <a href="http://learn.getchef.com/additional-resources/">Fundamentals Webinar</a> is a series of video tutorials and attendant slide decks that can augment the Learn Chef content.</li>
</ol>

<p>Regardless of the workflow you eventually settle in to, these rules and basics apply across the board.</p>

<p>As a community, we should agree on one method for beginners to learn the fundamentals. We can add to the list above as more resources come on line (books, more content, etc.)</p>

<h1>Supported Workflows</h1>

<h2>Monolithic Repository Workflow</h2>

<p>This workflow presents the following key features:</p>

<ol>
<li>All of your Chef related source code, including any 3rd party dependencies, are tracked in one source control repository using Git.</li>
<li>External dependencies, and any local modifications to them, are made with built-in vendor branches, allowing you to easily track the upstream for modifications.</li>
</ol>

<p>This workflow is also the original supported Chef workflow.</p>

<h3>Setup</h3>

<p>To get started with this workflow, execute the following:</p>
<div class="highlight"><pre><span></span>$ chef generate repo chef-repo
$ git add .
$ git commit -a -m <span class="s2">&quot;First commit&quot;</span>
</pre></div>
<p><em>Note: This creates a chef-repo exactly like the one you would clone from GitHub today.</em></p>

<p>You now have a fresh Chef repository, ready for your content.</p>

<h3>How to create your Chef cookbooks</h3>

<p>To create a new cookbook, from the top of your chef-repo:</p>
<div class="highlight"><pre><span></span>$ chef generate cookbook snazzy
</pre></div>
<p><em>Note: We should make the generators smarter about knowing you are in a monolithic repo, and we should tune the generator to do the right things. Also, the options that exist in knife cookbook create need to be fully supported. For example, it should auto-detect the cookbooks directory is the right place.</em></p>

<p>When you are done writing your cookbook, add it to your git repository:</p>
<div class="highlight"><pre><span></span>$ git add snazzy
$ git commit -a -m <span class="s2">&quot;One snazzy cookbook&quot;</span>
</pre></div>
<h3>How to create your Chef policy (everything that isn&#39;t a cookbook)</h3>

<p>To create a new type of policy document, from the top of your chef-repo:</p>
<div class="highlight"><pre><span></span>$ chef generate THING name
</pre></div>
<p><em>Note: None of these generators exist yet. They should subsume the functionality of the attendant knife X commands, and be intelligent about which workflow we&#39;ve chosen.</em></p>

<p>This will result in a blank, JSON formatted policy document created in the appropriate
subdirectory of your repository. Edit it to your satisfaction, and then:</p>
<div class="highlight"><pre><span></span>$ git add .
$ git commit -a -m <span class="s2">&quot;Super dope policy&quot;</span>
</pre></div>
<h3>How to manage external dependencies</h3>

<p>In this workflow, all external dependencies are tracked within the same source code repository as your custom-built source code. To install, for example, a 3rd party cookbook called &quot;apache2&quot; from the <a href="http://supermarket.getchef.com">supermarket</a>:</p>
<div class="highlight"><pre><span></span>$ chef vendor dependencies
</pre></div>
<p><em>Note: this command should approximate the &#39;knife cookbook site install&#39; commands behavior, which is to fetch the cookbook and its dependencies from supermarket, and create vendor branches for each of them. Unlike cookbook site install, it should inspect all the metadata for every cookbook in the repository, and dynamically attempt to fetch any dependency it doesn&#39;t have. It should be version agnostic.</em></p>

<p>If you have a top level dependency, you can specify the cookbook name:</p>
<div class="highlight"><pre><span></span>$ chef vendor dependencies apache2
</pre></div>
<h3>How to test your cookbooks and policy</h3>

<p>When testing your cookbooks with <a href="https://github.com/sethvargo/chefspec">ChefSpec</a> or <a href="https://github.com/test-kitchen/test-kitchen">Test Kitchen</a>, all your cookbook dependencies should have been resolved with <code>chef vendor dependencies</code> above. You can then run your unit tests with:</p>
<div class="highlight"><pre><span></span>$ chef <span class="nb">test</span> unit
</pre></div>
<p>And your integration tests with:</p>
<div class="highlight"><pre><span></span>$ chef <span class="nb">test</span> integration
</pre></div>
<p><em>Note: We will need to have the generators for each of these tools drop off a standard file for dependency resolution that states we should exclusively look at the directory above us for our content. Also - should this really be chef test unit/chef test integration?</em></p>

<h3>How to publish your cookbooks and policy</h3>

<p>To publish your cookbooks and policy to a Chef Server:</p>
<div class="highlight"><pre><span></span>$ chef upload
</pre></div>
<p><em>Note: This is currently a knife command, that should be ported to the chef DK, so we can
abstract it against multiple workflows.</em></p>

<h2>Independent Software Projects Workflow</h2>

<p>This workflow presents the following key features:</p>

<ol>
<li>All of the Chef cookbooks are treated as independent software projects, that can be built in isolation from any other cookbook.</li>
<li>External dependencies are fetched as-needed, and treated as artifacts. Changes to the upstream creates a new software projects, and is tracked as such.</li>
</ol>

<h3>Setup</h3>

<p>To get started with this workflow, create a directory for your (multiple) source repositories.</p>
<div class="highlight"><pre><span></span>$ mkdir ~/src/chef
</pre></div>
<h3>How to create your Chef cookbooks</h3>

<p>To create a new cookbook, from the top of your source directory:</p>
<div class="highlight"><pre><span></span>$ chef generate cookbook snazzy
</pre></div>
<p><em>Note: We should recognize that we are in the independent software projects workflow, and adjust accordingly.</em></p>

<p>The cookbook will be automatically initialized as a git project - so when you are done with your first pass, commit it.</p>
<div class="highlight"><pre><span></span>$ git commit -a -m <span class="s2">&quot;One snazzy cookbook&quot;</span>
</pre></div>
<h3>How to create your Chef policy (everything that isn&#39;t a cookbook)</h3>

<p>Create a policy-only repository:</p>
<div class="highlight"><pre><span></span>$ chef generate repo chef-policy --policy-only
</pre></div>
<p><em>Note: this should create a chef-repo minus the cookbooks directory</em></p>

<p>To create a new type of policy document, from the top of your chef-policy directory:</p>
<div class="highlight"><pre><span></span>$ chef generate THING name
</pre></div>
<p>One exception to this structure are data bags:</p>
<div class="highlight"><pre><span></span>$ chef generate data-bag BAG_NAME ITEM_NAME
</pre></div>
<p><em>Note: None of these generators exist yet. They should subsume the functionality of the attendent knife X commands, and be intelligent about which workflow we&#39;ve chosen.</em></p>

<p>This will result in a blank, JSON formatted policy document created in the appropriate
subdirectory of your repository. Edit it to your satisfaction, and then:</p>
<div class="highlight"><pre><span></span>$ git add .
$ git commit -a -m <span class="s2">&quot;Super dope policy&quot;</span>
</pre></div>
<h3>How to manage external dependencies</h3>

<p>In this workflow, all external dependencies are tracked within their project that has the dependency directly, and treated as artifacts. Adding a dependency to your cookbooks metadata.rb will result in it being automatically downloaded and injected into your project on an add needed basis.</p>

<h3>How to test your cookbooks and policy</h3>

<p>When testing your cookbooks with <a href="https://github.com/sethvargo/chefspec">ChefSpec</a> or <a href="https://github.com/test-kitchen/test-kitchen">Test Kitchen</a>, your dependencies will be automatically resolved.</p>
<div class="highlight"><pre><span></span>$ chef <span class="nb">test</span> unit
</pre></div>
<p>And your integration tests with:</p>
<div class="highlight"><pre><span></span>$ chef <span class="nb">test</span> integration
</pre></div>
<p><em>Note: We will need to have the generators for each of these tools drop off a standard file for dependency resolution that states we should exlusively look at the directory above us for our content. Also - should this really be chef test unit/chef test integration?</em></p>

<h3>How to publish your cookbooks and policy</h3>

<p>To publish your cookbooks and policy to a chef server:</p>
<div class="highlight"><pre><span></span>$ chef upload
</pre></div>
<p><em>Note: This is currently a knife command, that should be ported to the chef DK, so we can abstract it against multiple workflows.</em></p>

<p>To publish your cookbooks for use with chef-zero:</p>
<div class="highlight"><pre><span></span>$ chef package / --policy<span class="o">=</span>~/src/chef-policy
</pre></div>
<p><em>Note: This command should package up all your cookbooks and extra policy as a Chef Solo tarball.</em></p>
    </div>
  </body>
</html>
